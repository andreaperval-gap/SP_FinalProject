<!DOCTYPE html>
<html>
<head>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    
    <!-- Page title -->
    <title>Scientific Programming - Project: Model Prediction</title>
        
    <!-- CSS -->
    <style>
        /* Page style */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #8F2A2B; 
            background: linear-gradient(120deg, #9531338a, #952628); 
            margin: 0;
            padding: 0;
        }

        /* Page logo */
        .page-logo{
            position: fixed;  
            top: 15px;
            left: 15px;
            width: 260px;      
            height: auto;
            margin: 0;         
            z-index: 1000;     
        }
        
        /* Page heading */
        h1 {
            text-align: center;
            font-size: 3rem; 
            font-weight: bold; 
            color: #ffffff; 
            font-family: 'Roboto', sans-serif; 
            margin: 20px 0;
        }

        /* Form container */
        form {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(10px); 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        select, input[type="text"], button {
            padding: 8px 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        select {
            background-color: #ffffff;
        }
        button {
            background-color: #1F2937;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background-color: #111827;
        }
        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .button-row button {
            flex: 1;
            margin-bottom: 0;
        }
        .btn-clear {
            background-color: #6B7280 !important;
        }
        .btn-clear:hover {
            background-color: #4B5563 !important;
        }
        .fields-2col{
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 columnas */
            gap: 12px 18px;
            margin-top: 10px;
            }

            .field label{
            display: block;
            margin-bottom: 6px;
            }

            .field input{
            width: 100%;
            margin-bottom: 0; /* el espacio lo maneja el gap */
            }

            .subtitle{
            text-align: center;
            margin: 0 0 14px;
            color: #ffffff; 
            font-family: 'Roboto', sans-serif; 
        }
        .output-box{
            margin-top: 14px;
            padding: 14px 16px;
            background: #ffffff;
            border-radius: 10px;
            font-size: 1.4rem;
            font-weight: 800;
            text-align: center;
            color: #111827;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        /* Model and Preset selectors row */
        .model-preset-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        .model-selector, .preset-selector-inline {
            flex: 1;
        }
        .model-selector label, .preset-selector-inline label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
        }
        .model-selector select, .preset-selector-inline select {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #1F2937;
            border-radius: 5px;
            background-color: #fff;
            cursor: pointer;
        }
        .preset-selector-inline select {
            background-color: #1F2937;
            color: white;
            font-weight: bold;
        }

        /* Metrics */
        #metrics{
            margin-top: 12px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 10px;
            }

            #metrics pre{
            white-space: pre-wrap;
            margin: 0;
            font-size: 0.9rem;
            }

            .error{
            color: #b91c1c;
            font-weight: 600;
        }

        /* Preset selector styles */
        .preset-section {
            background: rgba(31, 41, 55, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px dashed #1F2937;
        }
        .preset-section label {
            color: #1F2937;
            font-size: 0.95rem;
        }
        .preset-section select {
            width: 100%;
            margin-top: 8px;
            background-color: #1F2937;
            color: white;
            font-weight: bold;
        }
        .preset-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 6px;
            font-style: italic;
        }

        /* Field inputs with normal range indicators */
        .field input[type="number"] {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        .field input[type="number"]:focus {
            border-color: #1F2937;
            outline: none;
        }
        .field-hint {
            font-size: 0.75rem;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }
        .field-hint .normal-range {
            color: #28a745;
            font-weight: bold;
        }
    </style>
    <script>
        // Preset patient profiles for quick testing
        // Values calibrated to work with the trained KNN model
        const presets = {
            "": { label: "-- Select a preset or enter values manually --" },
            "healthy": {
                label: "游릭 Healthy Patient (NOT CKD)",
                age: 25, blood_pressure: 70, glucose: 90, urea: 20,
                creatinine: 0.6, sodium: 140, potassium: 4.0,
                hemoglobin: 16, pcv: 50, wbc: 6000, rbc_count: 5.5
            },
            "healthy_middle": {
                label: "游릭 Middle-aged Healthy (NOT CKD)",
                age: 40, blood_pressure: 75, glucose: 95, urea: 25,
                creatinine: 0.8, sodium: 142, potassium: 4.2,
                hemoglobin: 15.5, pcv: 48, wbc: 6500, rbc_count: 5.3
            },
            "ckd_mild": {
                label: "游리 Mild CKD Risk (CKD)",
                age: 55, blood_pressure: 90, glucose: 140, urea: 50,
                creatinine: 1.8, sodium: 135, potassium: 5.0,
                hemoglobin: 11, pcv: 35, wbc: 9000, rbc_count: 4.0
            },
            "ckd_moderate": {
                label: "游 Moderate CKD Risk (CKD)",
                age: 60, blood_pressure: 100, glucose: 160, urea: 70,
                creatinine: 3.5, sodium: 130, potassium: 5.5,
                hemoglobin: 9, pcv: 28, wbc: 10000, rbc_count: 3.5
            },
            "ckd_severe": {
                label: "游댮 Severe CKD Risk (CKD)",
                age: 70, blood_pressure: 110, glucose: 200, urea: 120,
                creatinine: 7.0, sodium: 125, potassium: 6.5,
                hemoglobin: 7, pcv: 22, wbc: 12000, rbc_count: 2.8
            },
            "elderly_healthy": {
                label: "游놊 Elderly Healthy (NOT CKD)",
                age: 65, blood_pressure: 75, glucose: 100, urea: 25,
                creatinine: 0.9, sodium: 141, potassium: 4.0,
                hemoglobin: 15, pcv: 47, wbc: 5500, rbc_count: 5.0
            },
            "diabetic_ckd": {
                label: "游뽖 Diabetic with CKD (CKD)",
                age: 50, blood_pressure: 95, glucose: 180, urea: 60,
                creatinine: 2.0, sodium: 134, potassium: 5.2,
                hemoglobin: 10, pcv: 32, wbc: 9500, rbc_count: 3.8
            }
        };

        // Apply preset values to form
        function applyPreset() {
            const presetKey = document.getElementById("preset_selector").value;
            if (!presetKey) return;
            
            const preset = presets[presetKey];
            const fields = ['age', 'blood_pressure', 'glucose', 'urea', 'creatinine', 
                           'sodium', 'potassium', 'hemoglobin', 'pcv', 'wbc', 'rbc_count'];
            
            fields.forEach(field => {
                if (preset[field] !== undefined) {
                    document.getElementById(field).value = preset[field];
                }
            });
        }

        // Load model
        async function loadModels(){
            const res = await fetch("/models/");
            const models = await res.json();

            const sel = document.getElementById("model_name");
            sel.innerHTML = models
            .map(m => `<option value="${m}">${m.replace(".pkl","")}</option>`)
            .join("");

            if (models.length) loadMetrics();
        }

        // Load metrics
        async function loadMetrics(){
            const modelName = document.getElementById("model_name").value;
            const metricsDiv = document.getElementById("metrics");
            metricsDiv.style.display = "none";

            const res = await fetch(`/metrics/?model_name=${encodeURIComponent(modelName)}`);
            if (res.ok){
            const txt = await res.text();
            metricsDiv.innerHTML = `<h3>Testing Metrics</h3><pre>${txt}</pre>`;
            metricsDiv.style.display = "block";
            } else {
            metricsDiv.innerHTML = `<div class="error">Metrics could not be loaded.</div>`;
            metricsDiv.style.display = "block";
            }
        }

        // Predict using model and input data
        async function predict(event){
            event.preventDefault();
            const formData = new FormData(event.target);

            const res = await fetch(event.target.action, { method:"POST", body: formData });
            const out = document.getElementById("output");
            out.style.display = "block";        
            out.className = "output-box";

            if (res.ok){
            const data = await res.json();
            out.textContent = `MODEL: ${data.model} | PREDICTION: ${data.prediction} (${data.label})`;
            out.className = "";
            } else {
            const err = await res.json();
            out.textContent = `Error: ${err.detail}`;
            out.className = "error";
            }
        }

        // Clear all form values
        function clearForm() {
            const fields = ['age', 'blood_pressure', 'glucose', 'urea', 'creatinine', 
                           'sodium', 'potassium', 'hemoglobin', 'pcv', 'wbc', 'rbc_count'];
            fields.forEach(field => {
                document.getElementById(field).value = '';
            });
            document.getElementById('preset_selector').value = '';
            document.getElementById('output').style.display = 'none';
        }

        document.addEventListener("DOMContentLoaded", loadModels);
    </script>

    
    
</head>

<!-- HTML -->
<body>
    <!-- University Icon -->
    <img src="/img/LogoUniversitat.png" alt="Logo" class="page-logo">

    <!-- Main Heading -->
    <h1>Prediction with Model</h1>

    <p class="subtitle">
        Steps:<br>
        1. Choose a model<br>
        2. Enter the clinical values<br>
        3. Press <b>Press to Predict</b>
    </p>

    <!-- Form for model prediction -->
    <form action="/predict/" method="post" onsubmit="predict(event)">
        
        <!-- Dropdown for selecting model and preset side by side -->
        <div class="model-preset-row">
            <div class="model-selector">
                <label for="model_name">Choose Model:</label>
                <select name="model_name" id="model_name" onchange="loadMetrics()"></select> 
            </div>
            <div class="preset-selector-inline">
                <label for="preset_selector">Patient Profile:</label>
                <select id="preset_selector" onchange="applyPreset()">
                    <option value="">-- Select Profile --</option>
                    <option value="healthy">游릭 Healthy Patient (NOT CKD)</option>
                    <option value="healthy_middle">游릭 Middle-aged Healthy (NOT CKD)</option>
                    <option value="elderly_healthy">游놊 Elderly Healthy (NOT CKD)</option>
                    <option value="ckd_mild">游리 Mild CKD Risk (CKD)</option>
                    <option value="ckd_moderate">游 Moderate CKD Risk (CKD)</option>
                    <option value="ckd_severe">游댮 Severe CKD Risk (CKD)</option>
                    <option value="diabetic_ckd">游뽖 Diabetic with CKD (CKD)</option>
                </select>
            </div>
        </div>
        <div id="metrics" style="display:none;"></div>

        <!-- Input fields for model parameters -->
        <div class="fields-2col">
        <div class="field">
            <label for="age">Age (years):</label>
            <input type="number" id="age" name="age" placeholder="e.g. 50" required>
        </div>

        <div class="field">
            <label for="blood_pressure">Blood Pressure (mmHg):</label>
            <input type="number" id="blood_pressure" name="blood_pressure" placeholder="e.g. 80" required>
            <div class="field-hint">Normal: <span class="normal-range">70-80 mmHg</span></div>
        </div>

        <div class="field">
            <label for="glucose">Glucose (mg/dL):</label>
            <input type="number" id="glucose" name="glucose" placeholder="e.g. 100" required>
            <div class="field-hint">Normal: <span class="normal-range">70-110 mg/dL</span></div>
        </div>

        <div class="field">
            <label for="urea">Urea (mg/dL):</label>
            <input type="number" id="urea" name="urea" placeholder="e.g. 30" required>
            <div class="field-hint">Normal: <span class="normal-range">20-40 mg/dL</span></div>
        </div>

        <div class="field">
            <label for="creatinine">Creatinine (mg/dL):</label>
            <input type="number" step="0.1" id="creatinine" name="creatinine" placeholder="e.g. 1.0" required>
            <div class="field-hint">Normal: <span class="normal-range">0.7-1.2 mg/dL</span></div>
        </div>

        <div class="field">
            <label for="sodium">Sodium (mEq/L):</label>
            <input type="number" id="sodium" name="sodium" placeholder="e.g. 140" required>
            <div class="field-hint">Normal: <span class="normal-range">135-145 mEq/L</span></div>
        </div>

        <div class="field">
            <label for="potassium">Potassium (mEq/L):</label>
            <input type="number" step="0.1" id="potassium" name="potassium" placeholder="e.g. 4.5" required>
            <div class="field-hint">Normal: <span class="normal-range">3.5-5.0 mEq/L</span></div>
        </div>

        <div class="field">
            <label for="hemoglobin">Hemoglobin (g/dL):</label>
            <input type="number" id="hemoglobin" name="hemoglobin" placeholder="e.g. 14" required>
            <div class="field-hint">Normal: <span class="normal-range">12-17 g/dL</span></div>
        </div>

        <div class="field">
            <label for="pcv">PCV - Packed Cell Volume (%):</label>
            <input type="number" id="pcv" name="pcv" placeholder="e.g. 44" required>
            <div class="field-hint">Normal: <span class="normal-range">36-50%</span></div>
        </div>

        <div class="field">
            <label for="wbc">WBC - White Blood Cells (/풮L):</label>
            <input type="number" id="wbc" name="wbc" placeholder="e.g. 8000" required>
            <div class="field-hint">Normal: <span class="normal-range">4,000-11,000/풮L</span></div>
        </div>

        <div class="field">
            <label for="rbc_count">RBC Count (millions/풮L):</label>
            <input type="number" step="0.1" id="rbc_count" name="rbc_count" placeholder="e.g. 5.0" required>
            <div class="field-hint">Normal: <span class="normal-range">4.0-5.5 M/풮L</span></div>
        </div>
        </div>

        <!-- Buttons -->
        <div class="button-row">
            <button type="submit">Press to Predict</button>
            <button type="button" class="btn-clear" onclick="clearForm()">Clear Values</button>
        </div>
        <!-- Output -->
        <div id="output" class="output-box" style="display:none;"></div>
    </form>
</body>    
</html>